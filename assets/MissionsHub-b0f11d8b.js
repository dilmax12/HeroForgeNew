import{j as s}from"./motion-3c015c26.js";import{r as d}from"./vendor-374d307f.js";import{d as Q,u as N,b as xe,s as pe,e as B,B as he,w as ge}from"./index-324810f8.js";import{d as be}from"./dynamicMissionsAI-cc3e32c1.js";import"./router-6c8d423a.js";import"./supabase-4349ac75.js";import"./icons-5fe8db7b.js";async function ve(e){var b,l;const h=e.maxTokens??220,p=e.temperature??.8;console.debug("[AI][Narrator] Dispatch",{provider:Q.getProvider(),maxTokens:h,temperature:p,promptLen:((b=e.prompt)==null?void 0:b.length)||0});try{const r=await Q.generateTextSafe({systemMessage:e.systemMessage,prompt:e.prompt,maxTokens:h,temperature:p});console.debug("[AI][Narrator] Completed",{provider:r.provider,model:r.model,textLen:((l=r.text)==null?void 0:l.length)||0});const f=(r.text||"").trim();return f.length>0?f:"O narrador observa em silêncio: o caminho segue adiante, carregado de escolhas e perigos. Coragem."}catch(r){return console.error("[AI][Narrator] Failed",{code:r==null?void 0:r.code,message:r==null?void 0:r.message,provider:r==null?void 0:r.provider,retryable:r==null?void 0:r.retryable}),"O destino vacila por instantes, mas a jornada continua. Siga em frente."}}function fe(){return"Você é o MESTRE DO JOGO em um RPG medieval de fantasia. Fale como um narrador envolvente, em PT-BR, com tom épico e emocional. Use 1–3 frases no máximo, sem listas, sem aspas."}async function W(e){const{heroName:h="herói",questTitle:p="missão",success:b,consequence:l="",rewardSummary:r=""}=e,g=`Gere uma narração breve (2–3 frases) sobre o resultado da missão "${p}" do herói ${h}. Resultado: ${b?"vitória":"revés"}. `+(r?`Recompensas: ${r}. `:"")+(l?`Consequências: ${l}. `:"")+"Realce emoção, tensão e aprendizado, sem usar aspas.";return ve({systemMessage:fe(),prompt:g,maxTokens:160,temperature:.8})}const ye=e=>{switch(e){case"F":case"E":return 3;case"D":case"C":return 4;case"B":return 5;case"A":return 6;case"S":return 7;default:return 3}};function Ne(){var _,J,U;const e=N(t=>t.getSelectedHero()),h=N(t=>t.updateHero),p=N(t=>t.gainXP);N(t=>t.gainGold);const b=N(t=>t.updateDailyGoalProgress),[l,r]=d.useState(0),[f,g]=d.useState(!1),[Y,E]=d.useState(""),[Z,C]=d.useState([]),[a,j]=d.useState(null),[ee,A]=d.useState([]),[D,H]=d.useState([]),[G,k]=d.useState(!1),[O,q]=d.useState("none"),[je,$]=d.useState(""),[F,I]=d.useState(!1),[X,L]=d.useState(!1),y=d.useMemo(()=>{var n;const t=(n=e==null?void 0:e.rankData)==null?void 0:n.currentRank;return ye(t)},[(_=e==null?void 0:e.rankData)==null?void 0:_.currentRank]),P=d.useMemo(()=>{const t=(e==null?void 0:e.progression.level)||1;return t<4?"easy":t<8?"medium":"hard"},[e==null?void 0:e.progression.level]),se=(e==null?void 0:e.derivedAttributes.hp)||1,te=((e==null?void 0:e.derivedAttributes.currentHp)??se)<=0,{activeSeasonalTheme:z}=xe(),ae=z&&((J=pe[z])==null?void 0:J.border)||"border-gray-700",T=d.useRef(!1);if(d.useEffect(()=>{(async()=>{if(!T.current){T.current=!0,g(!0),j(null);try{if(!e)return;const n=`Masmorra IA — Etapa ${l+1}/${y}. Herói: ${e.name} nível ${e.progression.level}.`,c=await be.generateMission({hero:e,missionType:"mystery",difficulty:P,context:n});E(c.description);const i=Math.min(.85,.3+(e.derivedAttributes.power||5)/40),x=Math.min(.95,i+.1),m=Math.max(.25,i-.1);C([{key:"Explorar",text:"Explorar a sala e procurar pistas",success:i},{key:"Cautela",text:"Avançar com cautela evitando armadilhas",success:x},{key:"Audácia",text:"Forçar passagem correndo riscos por recompensas",success:m}])}catch(n){console.warn("[AIDungeonRun] Falha ao gerar missão IA, usando opções locais:",n);const c=Math.min(.85,.3+((e==null?void 0:e.derivedAttributes.power)||5)/40),i=Math.min(.95,c+.1),x=Math.max(.25,c-.1);E(`Etapa ${l+1}/${y}: A sala está silenciosa, com marcas de batalha recentes nas paredes.`),C([{key:"Explorar",text:"Vasculhar a área em busca de pistas",success:c},{key:"Cautela",text:"Prosseguir com cuidado, evitando armadilhas",success:i},{key:"Audácia",text:"Forçar passagem em busca de atalhos",success:x}])}finally{g(!1),T.current=!1}}})()},[l,e==null?void 0:e.id,P,y]),!e)return s.jsxs("div",{className:"max-w-3xl mx-auto p-6 text-center",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Masmorra IA"}),s.jsx("p",{className:"text-gray-600",children:"Nenhum herói selecionado. Selecione um herói para iniciar a aventura."})]});const re=((U=e.rankData)==null?void 0:U.currentRank)||B.calculateRank(e),V=(()=>{const t={F:0,E:1,D:2,C:3,B:4,A:5,S:6};return(t[String(re)]||0)<t.D})();if(V)return s.jsx("div",{className:"max-w-3xl mx-auto p-6",children:s.jsxs("div",{className:"mb-4 p-4 rounded-lg bg-red-900/30 border border-red-600/40",children:[s.jsx("div",{className:"text-white font-semibold",children:"Masmorra Infinita bloqueada"}),s.jsx("div",{className:"text-sm text-red-200",children:"Requer Rank D ou superior. Avance nos treinos e missões para desbloquear."}),s.jsxs("div",{className:"mt-2 flex gap-2",children:[s.jsx("a",{href:"/training",className:"px-3 py-2 rounded bg-amber-600 text-black text-xs",children:"Treinar"}),s.jsx("a",{href:"/quests",className:"px-3 py-2 rounded bg-gray-800 text-white text-xs",children:"Missões"})]})]})});const ne=2,oe=t=>{ge.consumeStamina(e,t),h(e.id,{stamina:e.stamina})},ie=t=>{const n=e.id,c=e.derivedAttributes.hp||20,i=e.derivedAttributes.currentHp??c,x=Math.min(c,i+t);return h(n,{derivedAttributes:{...e.derivedAttributes,currentHp:x}}),x-i},ce=async(t,n)=>{var c,i;if(!f&&!te){g(!0);try{oe(ne);const m=Math.random()<n;let u="none";const M=Math.random();m?M<.3?u="rest":M<.6?u="chest":u="none":u=M<.7?"combat":"chest";let o={success:m,narrative:""};if(u==="combat"){const v=["Goblin","Esqueleto","Bandido"],S=[{type:v[Math.floor(Math.random()*v.length)],count:1,level:e.progression.level}];H(S),q("combat"),$(t),I(m),k(!0),g(!1);return}else if(u==="rest"){const v=ie(Math.round((e.derivedAttributes.hp||20)*.35));o.rest={healedHp:v},o.xp=m?6:3,p(e.id,o.xp)}else if(u==="chest")if(Math.random()<.28){const S=[{type:"Esqueleto",count:1,level:e.progression.level}];H(S),q("chest"),$(t),I(m),j({success:m,narrative:"",chest:{isMimic:!0,gold:0}}),k(!0),g(!1);return}else{const w=["Poção de Cura","Runas antigas","Talismã simples"],S=Math.random()<.5?w[Math.floor(Math.random()*w.length)]:void 0;o.chest={isMimic:!1,item:S},o.xp=8,p(e.id,8)}else o.xp=m?8:3,p(e.id,o.xp);const me=`${o.xp?`${o.xp} XP`:""}`,ue=u==="combat"?(c=o.combat)!=null&&c.victory?"vitória em combate":"derrota em combate":u==="rest"?"recupera forças na sala de descanso":u==="chest"?(i=o.chest)!=null&&i.isMimic?"baú era um mímico":"baú com tesouros":"progresso seguro",K=await W({heroName:e.name,questTitle:"Masmorra IA",success:o.success,rewardSummary:me,consequence:ue});o.narrative=K,j(o),A(v=>[...v,`Etapa ${l+1}: ${K}`])}finally{g(!1)}}},de=()=>{l+1>=y||r(t=>t+1)},le=()=>{r(0),E(""),C([]),j(null),A([]),L(!1)},R=l+1>=y&&!!a;return d.useEffect(()=>{if(!R||X)return;const t=N.getState(),n=t.heroes.find(m=>m.id===e.id);if(!n)return;const c={...n.stats,questsCompleted:(n.stats.questsCompleted||0)+1,lastActiveAt:new Date().toISOString()};t.updateHero(e.id,{stats:c});const i=n.rankData??B.initializeRankData(n),x=B.updateRankData({...n,stats:c},i);t.updateHero(e.id,{rankData:x}),b(e.id,"quest-completed",1),L(!0)},[R,X,e.id,b]),s.jsxs("div",{className:"max-w-3xl mx-auto p-6",children:[V&&s.jsxs("div",{className:"mb-4 p-4 rounded-lg bg-red-900/30 border border-red-600/40",children:[s.jsx("div",{className:"text-white font-semibold",children:"Masmorra Infinita bloqueada"}),s.jsx("div",{className:"text-sm text-red-200",children:"Requer Rank D ou superior. Avance nos treinos e missões para desbloquear."}),s.jsxs("div",{className:"mt-2 flex gap-2",children:[s.jsx("a",{href:"/training",className:"px-3 py-2 rounded bg-amber-600 text-black text-xs",children:"Treinar"}),s.jsx("a",{href:"/quests",className:"px-3 py-2 rounded bg-gray-800 text-white text-xs",children:"Missões"})]})]}),s.jsx("h2",{className:"text-2xl font-bold text-white",children:"Masmorra IA"}),s.jsxs("p",{className:"text-gray-300",children:["Etapa ",l+1," de ",y," • Dificuldade: ",P]}),s.jsxs("div",{className:`mt-4 p-4 border rounded bg-gray-800 ${ae}`,children:[s.jsx("p",{className:"text-gray-200 whitespace-pre-line",children:Y}),s.jsx("div",{className:"mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2",children:Z.map(t=>s.jsxs("button",{onClick:()=>ce(t.key,t.success),className:"border border-gray-700 bg-gray-700 text-gray-100 px-3 py-2 rounded hover:bg-gray-600 disabled:opacity-50",disabled:f||!!a||G,children:[s.jsx("div",{className:"font-medium text-white",children:t.key}),s.jsx("div",{className:"text-sm text-gray-200",children:t.text}),s.jsxs("div",{className:"text-xs text-gray-300",children:["Sucesso ~",Math.round(t.success*100),"%"]})]},t.key))}),a&&s.jsxs("div",{className:"mt-4 p-3 bg-gray-700 rounded",children:[s.jsxs("div",{className:"text-lg font-semibold text-white",children:["Resultado: ",a.success?"Sucesso":"Falha"]}),s.jsx("p",{className:"mt-1 text-gray-200",children:a.narrative}),a.rest&&s.jsxs("div",{className:"mt-2 text-sm text-gray-300",children:["Sala de descanso: +",a.rest.healedHp," HP"]}),a.chest&&s.jsxs("div",{className:"mt-2 text-sm text-gray-300",children:[a.chest.isMimic?"Era um Mímico!":"Baú encontrado"," ",a.chest.item?`• Item: ${a.chest.item}`:""]}),a.combat&&s.jsxs("div",{className:"mt-2 text-sm text-gray-300",children:["Combate contra ",a.combat.enemies.join(", ")," — ",a.combat.victory?"Vitória":"Derrota"]}),a.xp&&s.jsxs("div",{className:"mt-1 text-xs text-gray-300",children:["Recompensas: ",a.xp," XP"]}),s.jsxs("div",{className:"mt-3 flex gap-2",children:[!R&&s.jsx("button",{onClick:de,className:"px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700",children:"Prosseguir"}),R&&s.jsx("button",{onClick:le,className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Reiniciar masmorra"})]})]}),s.jsxs("div",{className:"mt-6",children:[s.jsx("h3",{className:"text-white font-semibold",children:"Registro"}),s.jsx("ul",{className:"mt-2 text-sm text-gray-300 list-disc pl-5",children:ee.map((t,n)=>s.jsx("li",{children:t},n))})]})]}),G&&D.length>0&&s.jsx(he,{hero:e,enemies:D,floor:l+1,partyRarityBonusPercent:0,onClose:()=>k(!1),onResult:t=>{p(e.id,t.xpGained||0);const n=e.derivedAttributes.currentHp??(e.derivedAttributes.hp||0),c=Math.max(0,n-(t.damage||0));h(e.id,{derivedAttributes:{...e.derivedAttributes,currentHp:c}});const i=t.victory,x=`${t.xpGained||0} XP`,m=O==="combat"?i?"vitória em combate":"derrota em combate":"baú era um mímico";W({heroName:e.name,questTitle:"Masmorra IA",success:F||i,rewardSummary:x,consequence:m}).then(u=>{const M={success:F||i,narrative:u,xp:((a==null?void 0:a.xp)||0)+(t.xpGained||0),combat:{enemies:D.map(o=>o.type),victory:i},rest:a==null?void 0:a.rest,chest:(a==null?void 0:a.chest)||(O==="chest"?{isMimic:!0}:void 0)};j(M),A(o=>[...o,`Etapa ${l+1}: ${u}`]),c<=0&&A(o=>[...o,`⚠️ ${e.name} caiu na masmorra e está em recuperação. Aguarde a regeneração de vida.`]),k(!1),H([]),q("none"),$(""),I(!1)})}})]})}function De(){return s.jsxs("div",{className:"max-w-full md:max-w-6xl mx-auto px-3 md:px-6",children:[s.jsxs("div",{className:"mb-4 md:mb-6",children:[s.jsx("h1",{className:"text-xl md:text-2xl font-bold text-amber-300",children:"Jogar"}),s.jsx("p",{className:"text-xs sm:text-sm text-gray-300",children:"Modo de masmorra por etapas com decisões e batalhas."})]}),s.jsx("div",{className:"rounded-lg bg-gray-800 p-3 md:p-4",children:s.jsx(Ne,{})})]})}export{De as default};
//# sourceMappingURL=MissionsHub-b0f11d8b.js.map
